<html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">  

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script type="text/javascript" src="lib/protovis-3.2/protovis-d3.2.js"></script>
<script type="text/javascript" charset="utf-8" src="utils.js"></script>
<script type="text/javascript" charset="utf-8" src="lib/lodash.underscore.min.js"></script>
<script type="text/javascript" charset="utf-8" src="lib/js-xlsx/dist/xlsx.core.min.js"></script>
<script type="text/javascript" charset="utf-8" src="radars/radarData.js"></script>

<style type="text/css" media="screen">
  
#fig {
  height: 1000px;
  width: 1200px;
}

</style>
<script type="text/javascript" src="radar.js" charset="utf-8"></script>

</head>

<body onload="init(h,w);">
<h1 id="title" style="text-align: center;"></h1>
<input type="file" id="files" name="files[]" />
<div id="radar"></div>
<div>
<p>^ Item in dispute, additional discussion and context to be provided.</p>
</div>
</body>

<script type="text/javascript" charset="utf-8">

function handleFile(e) {
  var files = e.target.files;
  var i,f;
  for (i = 0, f = files[i]; i != files.length; ++i) {
    var reader = new FileReader();
    var name = f.name;
    reader.onload = function(e) {
      var d = e.target.result;

      var workbook = XLSX.read(d, {type: 'binary'});

      /* DO SOMETHING WITH workbook HERE */
      console.log("Ready to start");
      var first_sheet_name = workbook.SheetNames[0];
      var worksheet = workbook.Sheets[first_sheet_name];
      console.log(rowsToArray(worksheet));
      var a = rowsToArray(worksheet);
      for(quad in radar_data){
          radar_data[quad].items = arrayToRadarItem(a, radar_data[quad].quadrant);
      }
      init(h,w); // Redraw
    };
    reader.readAsBinaryString(f);
  }
}

function rowsToArray(ws) {
  var cur_row = 0;
  var rows = [];
  var temp_row = [];
    
  for(z in ws) {
      if( z[0] === '!' ) continue;
      if( XLSX.utils.decode_cell(z).r === 0 ) continue; // Consider the first row as headings
      // console.log(z + " is " + ws[z].v);
      if( cur_row === XLSX.utils.decode_cell(z).r) {
          temp_row.push(ws[z].v);

      } else {
          cur_row = XLSX.utils.decode_cell(z).r;
          if( temp_row.length > 0 ) {
              rows.push(temp_row);
          }
          temp_row = [ws[z].v];
      }

  };

  rows.push(temp_row);
  return rows;
}

function arrayToRadarItem(arr, cat) {
    var items = [];
    var pos_name = 1; // Name
    var pos_cat = 2; // Catagory
    var pos_rec = 3; // Recommendation

    for( i in arr ) {
        if( arr[i][pos_cat] != cat ) continue;
        var radius = arcNameToRadius(arr[i][pos_rec]); // TODO Hard coded value here
        var angle = catNameToAngle(cat);
        var temp_item = {"name":arr[i][pos_name], "pc":{"r":radius,"t":angle},"movement":"c"};
        items.push(temp_item);
    }
    return items;
}

function arcNameToRadius(n) {

    for ( a in radar_arcs ) {
        if ( n === radar_arcs[a].name ) return radar_arcs[a].r - 50; // TODO hard coded
    }

    return 0; // Did not match any of the names

}

function catNameToAngle(catagory){
    for (c in radar_angle_range) {
        if (catagory === radar_angle_range[c].name ){
            return Math.floor((Math.random() * (radar_angle_range[c].e - radar_angle_range[c].s)) + radar_angle_range[c].s);
        }
    }

    return 0; // Did not match any of the catagories

}

document.getElementById('files').addEventListener('change', handleFile, false);

</script>
</html>
